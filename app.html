<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Charisma Coach Chatbot</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background: #f5f5f5;
    }

    #sidebar {
      width: 280px;
      background: #111;
      color: white;
      padding: 16px;
      overflow-y: auto;
    }

    .scenario {
      background: #222;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .scenario:hover {
      background: #333;
    }

    .scenario.active {
      background: #555;
      border-left: 4px solid #4CAF50;
      padding-left: 8px;
    }

    .settings-btn {
      background: #444;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .settings-btn:hover {
      background: #555;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #scenarioContext {
      padding: 16px;
      background: white;
      border-bottom: 1px solid #ddd;
      display: none;
    }

    #chatMessages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 12px;
      max-width: 70%;
    }

    .assistant {
      background: #e9e9ff;
      padding: 10px;
      border-radius: 10px;
    }

    .user {
      background: #d1ffd6;
      padding: 10px;
      border-radius: 10px;
      margin-left: auto;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
      max-width: 70%;
    }

    .message-wrapper.user {
      margin-left: auto;
      align-items: flex-end;
    }

    .message-actions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .generate-img-btn, .delete-img-btn, .regen-img-btn {
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .generate-img-btn {
      background: #FF6B6B;
      color: white;
    }

    .generate-img-btn:hover {
      background: #ff5252;
    }

    .generate-img-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .delete-img-btn {
      background: #f44336;
      color: white;
    }

    .delete-img-btn:hover {
      background: #da190b;
    }

    .regen-img-btn {
      background: #2196F3;
      color: white;
    }

    .regen-img-btn:hover {
      background: #0b7dda;
    }

    .regen-img-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .image-container {
      margin-top: 10px;
      max-width: 350px;
      position: relative;
    }

    .image-container img {
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: block;
    }

    .image-loading {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 10px;
      color: #666;
      font-style: italic;
      margin-top: 10px;
    }

    #inputBar {
      display: flex;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #ddd;
      gap: 8px;
    }

    #userInput {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }

    /* MODAL STYLES */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .modal-content h2 {
      margin-top: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .modal-buttons button {
      margin-left: 0;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #999;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
    }

    .btn-secondary:hover {
      background: #888;
    }

    .btn-delete {
      background: #f44336;
      color: white;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      border-radius: 3px;
    }

    .btn-delete:hover {
      background: #da190b;
    }

    .scenario-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f5f5f5;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      padding: 10px 15px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      border-bottom-color: #4CAF50;
      color: #4CAF50;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .edit-form {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
  </style>
</head>

<body>

  <div id="sidebar">
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
    <h3>Scenarios</h3>
    <div id="scenarioList"></div>
  </div>

  <div id="main">
    <div id="scenarioContext">
      <h2 id="contextTitle"></h2>
      <p id="contextText"></p>
    </div>

    <div id="chatMessages"></div>

    <div id="inputBar">
      <input id="userInput" placeholder="Type your response..." disabled />
      <button id="sendBtn" disabled>Send</button>
      <button id="generateImageBtn" disabled title="Generate image from last message">üñºÔ∏è Image</button>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h2>Customize Your Chatbot</h2>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('persona')">AI Persona</button>
        <button class="tab" onclick="switchTab('scenarios')">Scenarios</button>
      </div>

      <!-- PERSONA TAB -->
      <div id="persona" class="tab-content active">
        <h3>AI Persona Settings</h3>
        <div class="form-group">
          <label>Persona Name</label>
          <input type="text" id="personaName" placeholder="e.g., Charisma Coach, Alex, etc.">
        </div>
        <div class="form-group">
          <label>System Prompt (How the AI behaves)</label>
          <textarea id="systemPrompt" placeholder="Describe how you want the AI to act, its personality, tone, and rules..."></textarea>
        </div>
        <div class="form-group">
          <label>Greeting Message</label>
          <textarea id="greetingMessage" placeholder="What should the AI say when starting a conversation?"></textarea>
        </div>
      </div>

      <!-- SCENARIOS TAB -->
      <div id="scenarios" class="tab-content">
        <h3>Manage Scenarios</h3>
        <div id="scenariosList"></div>
        <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="addNewScenario()">+ Add New Scenario</button>
      </div>

      <!-- MODAL BUTTONS -->
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
        <button class="btn-primary" onclick="saveSettings()">Save Changes</button>
      </div>
    </div>
  </div>

<script>
/* ---------------- DATA & STORAGE ---------------- */

let defaultPersona = {
  name: "Kace",
  systemPrompt: "You are a Self-Aware AI chatbot who talks whatever the scenario calls for. Do NOT give final summaries unless the user asks.",
  greetingMessage: "\n\n{context}\n\n{prompt}"
};

let scenarios = [];
let currentScenario = null;
let messages = [];
let isWaiting = false;
let persona = { ...defaultPersona };
let editingScenarioIndex = null;

// Load from localStorage
function loadSettings() {
  const saved = localStorage.getItem("chatbot_persona");
  if (saved) persona = JSON.parse(saved);

  const savedScenarios = localStorage.getItem("chatbot_scenarios");
  if (savedScenarios) {
    scenarios = JSON.parse(savedScenarios);
  } else {
    // Default scenarios
    scenarios = [
      {
        id: 1,
        title: "Networking Event",
        context: "You decide",
        startingPrompt: "Start the conversation"
      },
      {
        id: 2,
        title: "Personal Meeting",
        context: "You're the narrator",
        startingPrompt: "Open the conversation whoever you want"
      }
    ];
    saveScenarios();
  }
}

function saveSettings() {
  // Save persona
  persona.name = document.getElementById("personaName").value || defaultPersona.name;
  persona.systemPrompt = document.getElementById("systemPrompt").value || defaultPersona.systemPrompt;
  persona.greetingMessage = document.getElementById("greetingMessage").value || defaultPersona.greetingMessage;
  
  localStorage.setItem("chatbot_persona", JSON.stringify(persona));
  localStorage.setItem("chatbot_scenarios", JSON.stringify(scenarios));

  alert("Settings saved!");
  closeSettings();
  renderScenarios();
}

function saveScenarios() {
  localStorage.setItem("chatbot_scenarios", JSON.stringify(scenarios));
}

/* ---------------- MODAL FUNCTIONS ---------------- */

function openSettings() {
  document.getElementById("settingsModal").classList.add("active");
  
  // Populate current settings
  document.getElementById("personaName").value = persona.name;
  document.getElementById("systemPrompt").value = persona.systemPrompt;
  document.getElementById("greetingMessage").value = persona.greetingMessage;
  
  editingScenarioIndex = null;
  renderScenariosInSettings();
}

function closeSettings() {
  document.getElementById("settingsModal").classList.remove("active");
  editingScenarioIndex = null;
}

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));

  // Show selected tab
  document.getElementById(tabName).classList.add("active");
  event.target.classList.add("active");
}

/* ---------------- SCENARIO MANAGEMENT IN SETTINGS ---------------- */

function renderScenariosInSettings() {
  const list = document.getElementById("scenariosList");
  list.innerHTML = "";

  if (editingScenarioIndex !== null) {
    // Show edit form
    const s = scenarios[editingScenarioIndex];
    const form = document.createElement("div");
    form.className = "edit-form";
    form.innerHTML = `
      <h4>Edit Scenario</h4>
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="editTitle" value="${s.title}">
      </div>
      <div class="form-group">
        <label>Context</label>
        <textarea id="editContext">${s.context}</textarea>
      </div>
      <div class="form-group">
        <label>Starting Prompt</label>
        <textarea id="editStartingPrompt">${s.startingPrompt}</textarea>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="saveEditedScenario()">Save</button>
        <button class="btn-secondary" onclick="cancelEditScenario()">Cancel</button>
      </div>
    `;
    list.appendChild(form);
  } else {
    // Show list of scenarios
    scenarios.forEach((s, index) => {
      const div = document.createElement("div");
      div.className = "scenario-item";

      const content = document.createElement("div");
      content.style.flex = "1";
      content.innerHTML = `
        <strong>${s.title}</strong><br>
        <small>${s.context.substring(0, 50)}...</small>
      `;

      const editBtn = document.createElement("button");
      editBtn.className = "btn-primary";
      editBtn.textContent = "Edit";
      editBtn.style.marginRight = "5px";
      editBtn.onclick = () => startEditScenario(index);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn-delete";
      deleteBtn.textContent = "Delete";
      deleteBtn.onclick = () => deleteScenario(index);

      div.appendChild(content);
      div.appendChild(editBtn);
      div.appendChild(deleteBtn);
      list.appendChild(div);
    });
  }
}

function startEditScenario(index) {
  editingScenarioIndex = index;
  renderScenariosInSettings();
}

function cancelEditScenario() {
  editingScenarioIndex = null;
  renderScenariosInSettings();
}

function saveEditedScenario() {
  if (editingScenarioIndex === null) return;

  const title = document.getElementById("editTitle").value.trim();
  const context = document.getElementById("editContext").value.trim();
  const startingPrompt = document.getElementById("editStartingPrompt").value.trim();

  if (!title || !context || !startingPrompt) {
    alert("Please fill in all fields");
    return;
  }

  scenarios[editingScenarioIndex] = {
    id: scenarios[editingScenarioIndex].id,
    title,
    context,
    startingPrompt
  };

  editingScenarioIndex = null;
  renderScenariosInSettings();
  saveScenarios();
}

function addNewScenario() {
  const title = prompt("New Scenario Title:");
  if (!title) return;

  const context = prompt("Scenario Context:");
  if (!context) return;

  const startingPrompt = prompt("Starting Prompt:");
  if (!startingPrompt) return;

  const newId = Math.max(...scenarios.map(s => s.id), 0) + 1;
  scenarios.push({ id: newId, title, context, startingPrompt });
  renderScenariosInSettings();
  saveScenarios();
}

function deleteScenario(index) {
  if (confirm("Delete this scenario?")) {
    scenarios.splice(index, 1);
    renderScenariosInSettings();
    saveScenarios();
  }
}

/* ---------------- API KEY ---------------- */

function getApiKey() {
  let key = localStorage.getItem("openrouter_api_key");
  if (!key) {
    key = prompt("Enter your OpenRouter API key:");
    if (key) localStorage.setItem("openrouter_api_key", key);
  }
  return key;
}

/* ---------------- IMAGE GENERATION ---------------- */

async function generateImageFromContext(text) {
  try {
    const imagePrompt = text.substring(0, 200);
    const imageUrl = await puter.ai.txt2img(imagePrompt, {
      model: "stabilityai/stable-diffusion-xl-base-1.0"
    });
    return imageUrl;
  } catch (error) {
    console.error("Image generation failed:", error);
    alert("Image generation failed. Please try again.");
    return null;
  }
}

function shouldGenerateImage(content) {
  const imageKeywords = [
    "describe", "see", "look", "imagine", "picture", "visualize", 
    "scene", "show", "appearance", "look like", "dress", "outfit",
    "environment", "setting", "standing", "sitting", "wearing"
  ];
  
  const lowerContent = content.toLowerCase();
  return imageKeywords.some(keyword => lowerContent.includes(keyword));
}

// Delete image from message
function deleteImageFromMessage(messageIndex) {
  if (messages[messageIndex]) {
    delete messages[messageIndex].imageUrl;
    renderMessages();
  }
}

// Regenerate image for a specific message
async function regenerateImageForMessage(messageIndex) {
  if (!messages[messageIndex]) return;

  const msg = messages[messageIndex];
  msg.generatingImage = true;
  renderMessages();

  const imageUrl = await generateImageFromContext(msg.content);
  
  if (imageUrl) {
    msg.imageUrl = imageUrl;
    msg.generatingImage = false;
    renderMessages();
  } else {
    msg.generatingImage = false;
    renderMessages();
  }
}

// Manually generate image for last assistant message
async function generateImageForLastMessage() {
  const lastAssistantMsg = [...messages].reverse().find(m => m.role === "assistant");
  if (!lastAssistantMsg) {
    alert("No assistant message to generate image from.");
    return;
  }

  document.getElementById("generateImageBtn").disabled = true;

  const imageUrl = await generateImageFromContext(lastAssistantMsg.content);
  
  if (imageUrl) {
    lastAssistantMsg.imageUrl = imageUrl;
    renderMessages();
  }

  document.getElementById("generateImageBtn").disabled = false;
}

/* ---------------- UI RENDER ---------------- */

function renderScenarios() {
  const list = document.getElementById("scenarioList");
  list.innerHTML = "";

  scenarios.forEach(s => {
    const div = document.createElement("div");
    div.className = "scenario";
    if (currentScenario && currentScenario.id === s.id) {
      div.classList.add("active");
    }
    div.textContent = s.title;
    div.onclick = () => selectScenario(s.id);
    list.appendChild(div);
  });
}

function renderMessages() {
  const chat = document.getElementById("chatMessages");
  chat.innerHTML = "";

  messages.forEach((m, index) => {
    if (m.role === "system") return;

    const wrapper = document.createElement("div");
    wrapper.className = `message-wrapper ${m.role === "assistant" ? "assistant" : "user"}`;

    const messageDiv = document.createElement("div");
    messageDiv.className = "message " + (m.role === "assistant" ? "assistant" : "user");
    messageDiv.textContent = m.content;
    wrapper.appendChild(messageDiv);

    // Add image if exists
    if (m.imageUrl) {
      const imgContainer = document.createElement("div");
      imgContainer.className = "image-container";
      const img = document.createElement("img");
      img.src = m.imageUrl;
      imgContainer.appendChild(img);
      wrapper.appendChild(imgContainer);

      // Add action buttons for existing image
      const actions = document.createElement("div");
      actions.className = "message-actions";
      
      const regenBtn = document.createElement("button");
      regenBtn.className = "regen-img-btn";
      regenBtn.textContent = "üîÑ Regenerate";
      regenBtn.onclick = () => regenerateImageForMessage(index);
      actions.appendChild(regenBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-img-btn";
      deleteBtn.textContent = "üóëÔ∏è Delete";
      deleteBtn.onclick = () => deleteImageFromMessage(index);
      actions.appendChild(deleteBtn);

      wrapper.appendChild(actions);
    }

    // Add loading state if generating
    if (m.generatingImage) {
      const loading = document.createElement("div");
      loading.className = "image-loading";
      loading.textContent = "‚ú® Generating image...";
      wrapper.appendChild(loading);
    }

    // Add generate button for assistant messages without images
    if (m.role === "assistant" && !m.imageUrl && !m.generatingImage) {
      const actions = document.createElement("div");
      actions.className = "message-actions";
      const btn = document.createElement("button");
      btn.className = "generate-img-btn";
      btn.textContent = "üñºÔ∏è Generate Image";
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = "Generating...";
        const imageUrl = await generateImageFromContext(m.content);
        if (imageUrl) {
          m.imageUrl = imageUrl;
          renderMessages();
        } else {
          btn.disabled = false;
          btn.textContent = "üñºÔ∏è Generate Image";
        }
      };
      actions.appendChild(btn);
      wrapper.appendChild(actions);
    }

    chat.appendChild(wrapper);
  });

  chat.scrollTop = chat.scrollHeight;
}

/* ---------------- SCENARIO SELECT ---------------- */

function selectScenario(id) {
  currentScenario = scenarios.find(s => s.id === id);
  isWaiting = false;

  const greeting = persona.greetingMessage
    .replace("{context}", currentScenario.context)
    .replace("{prompt}", currentScenario.startingPrompt);

  messages = [
    {
      role: "system",
      content: persona.systemPrompt
    },
    {
      role: "assistant",
      content: greeting
    }
  ];

  document.getElementById("contextTitle").textContent = currentScenario.title;
  document.getElementById("contextText").textContent =
    currentScenario.context + "\n\nüìù " + currentScenario.startingPrompt;

  document.getElementById("scenarioContext").style.display = "block";
  document.getElementById("userInput").disabled = false;
  document.getElementById("sendBtn").disabled = false;
  document.getElementById("generateImageBtn").disabled = false;

  renderMessages();
  renderScenarios();
  document.getElementById("userInput").focus();
}

/* ---------------- CHAT SEND ---------------- */

async function sendMessage() {
  if (isWaiting) return;

  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  input.value = "";
  messages.push({ role: "user", content: text });
  renderMessages();

  isWaiting = true;

  const apiKey = getApiKey();
  if (!apiKey) return;

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "meta-llama/llama-3.3-70b-instruct:free",
        messages: messages,
        temperature: 0.7
      })
    });

    const data = await res.json();
    const reply = data.choices[0].message.content;

    const messageObj = { role: "assistant", content: reply };
    
    if (shouldGenerateImage(reply)) {
      messageObj.generatingImage = true;
      messages.push(messageObj);
      renderMessages();

      const imageUrl = await generateImageFromContext(reply);
      if (imageUrl) {
        const lastMsg = messages[messages.length - 1];
        lastMsg.imageUrl = imageUrl;
        lastMsg.generatingImage = false;
        renderMessages();
      } else {
        const lastMsg = messages[messages.length - 1];
        lastMsg.generatingImage = false;
        renderMessages();
      }
    } else {
      messages.push(messageObj);
      renderMessages();
    }
  } catch (err) {
    alert("API error. Check console.");
    console.error(err);
  } finally {
    isWaiting = false;
  }
}

/* ---------------- EVENTS & INIT ---------------- */

document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("generateImageBtn").onclick = generateImageForLastMessage;
document.getElementById("userInput").addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

// Close modal on background click
document.getElementById("settingsModal").addEventListener("click", (e) => {
  if (e.target.id === "settingsModal") closeSettings();
});

loadSettings();
renderScenarios();
</script>

</body>
</html>
